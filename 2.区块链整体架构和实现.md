# 区块链整体架构和实现

## 区块链挖矿过程

### 简要描述
1. 初始化区块链,创建一个空的区块链
2. 给空的区块链中添加一个创世区块
3. 创建一笔系统奖励的交易,并且要随着他人的交易账目一同写入新的区块
4. 获取当前区块链的最后一个区块
5. 通过`SHA256(最后一个区块的hash + 交易记录json + 随机数)`计算出新区块的hash值
6. 通过一些难度算法比如前n位为0,来校验hash值

### 代码流程
```java
//创建一个空的区块链
List<Block> blockchain = new ArrayList<Block>();

//生成一个创世区块
Block firstBlock = new Block(1, "1", System.currentTimeMillis(), new ArrayList<Transaction>(), 1, "1");

//将创世区块加入到区块链中
blockchain.add(firstBlock);

System.out.println("创建完创世区块的区块链:"+JSON.toJSONString(blockchain));

//创建一个空的交易集合
List<Transaction> transactions = new ArrayList<Transaction>();
Transaction t1 = new Transaction();
Transaction t2 = new Transaction();
Transaction t3 = new Transaction();
transactions.add(t1);
transactions.add(t2);
transactions.add(t3);

//创建一个系统奖励的交易
Transaction sysTran = new Transaction();
transactions.add(sysTran);

//获取到链的最后一个区块
Block latestBlock = blockchain.get(blockchain.size()-1);

int nonce = 1;
String hash;
while(true) {
	//hash值计算  = SHA256(最后一个区块的hash + 交易记录信息 + 随机数)
	hash = CryptoUtil.SHA256(latestBlock.getHash() + JSON.toJSONString(transactions) + nonce);
	System.out.println(hash);
	if(hash.startsWith("0000")) {
		System.out.println("计算正确,计算次数为"+nonce+",hash:"+hash);
		break;
	}
	nonce++;
	System.out.println("计算错误,计算次数为"+nonce+",hash:"+hash);
}

Block block2 = new Block(latestBlock.getIndex()+1, hash, System.currentTimeMillis(), transactions, nonce, latestBlock.getHash());

blockchain.add(block2);

System.out.println("挖矿后的区块链:"+JSON.toJSONString(blockchain));
```

## 关于比特币

### UTXO
1. unspent transaction output, 未花费交易输出
    1. 比特币拥有者的公钥锁定(加密)的一个数字
    2. UTXO就是比特币,比特币系统中只有UTXO,没有比特币
    3. 新的UTXO由挖矿或交易产生
2. UTXO存在全节点的数据库里面
3. 转账交易消耗自己的UTXO,同时生成新的UTXO,并用接收者的公钥锁定
4. 比特币系统中用户的"余额"实际上并不直接存在,而是通过计算得到

### 交易模型
1. 交易输出